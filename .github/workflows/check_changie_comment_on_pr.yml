# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
---
    name: Changelog
    
    on:
      pull_request:
        types: [opened, reopened, labeled, unlabeled, synchronize]
      workflow_dispatch:
    
    concurrency:
      group: ${{ format('{0}-{1}-{2}-{3}-{4}', github.workflow, github.event_name, github.ref, github.base_ref || null, github.head_ref || null) }}
      cancel-in-progress: true
    
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    jobs:
      test:
        runs-on: ubuntu-latest
        name: test
        steps:
          - run: echo "test"
          - run: echo "$GITHUB_CONTEXT"
          - run: echo "$GITHUB_ACTOR"

      changelog-existence:
        name: Check Changelog
        if: ${{ !contains(github.event.pull_request.labels.*.name, 'skip-changelog') && github.actor != 'dependabot[bot]' }}
        runs-on: ubuntu-latest
        steps:
          - name: Checkout
            uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    
          - name: Output GitHub Variables
            run: env | grep GITHUB

          - name: Check if changelog file was added
            uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
            id: changelog_check
            with:
              filters: |
                exists:
                  - added|modified: '.changes/unreleased/**.yaml'
    
          - name: Setup Go
            if: steps.changelog_check.outputs.exists == 'true'
            uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4d7d973ad74ed # v5.1.0
            with:
              go-version-file: go.mod
              cache: true
                
          - name: Install Changie
            if: steps.changelog_check.outputs.exists == 'true'
            run: |
                go install github.com/miniscruff/changie@latest
                go mod download
    
          - name: Pass if changelog entry exists
            if: steps.changelog_check.outputs.exists == 'true'
            run: |
              echo "Changelog entry exists."
              exit 0
    
          - name: Fail if changelog entry is missing and required
            if: steps.changelog_check.outputs.exists == 'false'
            run: |
              echo "ðŸ›‘ Changelog entry required to merge."
              exit 1
    
      changelog-skip:
        name: Check Changelog
        if: ${{ contains(github.event.pull_request.labels.*.name, 'skip-changelog') || github.actor == 'dependabot[bot]' }}
        runs-on: ubuntu-latest
        steps:
          - name: Find comment
            if: github.actor != 'dependabot[bot]'
            uses: peter-evans/find-comment@3eae4d37986fb5a8592848f6a574fdf654e61f9e # v3.1.0
            id: fc
            with:
              issue-number: ${{ github.event.pull_request.number }}
              comment-author: github-actions[bot]
              body-includes: "<!-- changelog -->"
    
          - name: Delete comment
            uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
            if: github.actor != 'dependabot[bot]' && steps.fc.outputs.comment-id != ''
            with:
              script: |
                github.rest.issues.deleteComment({
                  ...context.repo,
                  comment_id: ${{ steps.fc.outputs.comment-id }},
                });
    
          - name: Pass (skip)
            run: exit 0
