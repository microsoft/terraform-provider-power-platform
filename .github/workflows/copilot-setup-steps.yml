name: "Copilot Setup Steps"
description: "Install tools needed for Copilot Agent"

on: workflow_dispatch

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version-file: 'go.mod'
          cache: true
          
      - name: golangci-lint
        uses: golangci/golangci-lint-action@4afd733a84b1f43292c63897423277bb7f4313a9 # v8.0.0
        with:
          version: v2.1.6

      - name: "Install Changie (changelog tool)"
        uses: miniscruff/changie-action@v2
        with:
          version: "1.21.1"

      - name: "Install Terraform"
        run: |
          TERRAFORM_VERSION=1.11.4
          OS=linux
          ARCH=amd64
          curl -LO https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_${OS}_${ARCH}.zip
          unzip terraform_${TERRAFORM_VERSION}_${OS}_${ARCH}.zip terraform
          sudo mv terraform /usr/local/bin/
          rm terraform_${TERRAFORM_VERSION}_${OS}_${ARCH}.zip
          terraform --version

      - name: "Install Go tools from tools.go"
        run: |
          go install github.com/hashicorp/terraform-plugin-docs/cmd/tfplugindocs@0.21.0

      - name: "Verify installation and setup Go modules"
        run: |
          echo "=== Installed Tools Verification ==="
          changie --version
          golangci-lint --version
          terraform --version
          tfplugindocs --version
          go version
          echo "=== Setting up Go modules ==="
          go mod tidy
          echo "=== Setup complete ==="
